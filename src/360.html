<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <link rel="icon" href="../public/lg.png" type="image/x-icon">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MadaExplore 360</title>
        <style>
            *  {
                margin: 0;
                padding: 0;
            }

            html, body {
                position: relative;
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #video360 {
                width: 100%;
                height: 100%;
            }

            #loadingScreen {
                position: absolute;
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                background-color: #022d50;
                z-index: 10;
            }

            #logo {
                width: 380px;
                height: 200px;
                margin-bottom: 15px;
            }

            #loader {
                border: 8px solid #f3f0f7;
                border-top: 8px solid #93e864;
                border-radius: 50%;
                width: 60px;
                height: 60px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body>
        <div id="loadingScreen">
            <img id="logo" src="../public/light.png" alt="Logo">
            <div id="loader"></div>
        </div>
        <div id="video360"></div>

        <script>
            window.onload = async function() {
                function extractYouTubeVideoId(url) {
                    const videoIdMatch = url.match(/embed\/([a-zA-Z0-9_-]{11})/);

                    return ((videoIdMatch && videoIdMatch[1]) ? videoIdMatch[1] : null);
                }

                function getDataFromLocalStorage() {
                    let selectedItem = localStorage.getItem('userChoice');
                    if (selectedItem)
                        selectedItem = JSON.parse(selectedItem);
                    localStorage.removeItem('userChoice');

                    return (extractYouTubeVideoId(selectedItem.link));
                }
                var video_id = await getDataFromLocalStorage();

                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                var player;
                window.onYouTubeIframeAPIReady = function () {
                    player = new YT.Player('video360', {
                        height: document.querySelector('#video360').offsetHeight,
                        width: document.querySelector('#video360').offsetWidth,
                        videoId: video_id,
                        playerVars: {
                            autoplay: 1,        // Activer la lecture automatique
                            controls: 0,        // Désactiver les contrôles
                            rel: 0,             // Ne pas montrer les vidéos suggérées à la fin
                            loop: 1,            // Activer la lecture en boucle
                            vq: 'hd2160',       // Qualité vidéo 4K (2160p)
                            modestbranding: 1,  // Réduire le branding YouTube
                            fs: 1               // Activer le mode plein écran
                        },
                        events: { 
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange
                        }
                    });
                }

                function onPlayerReady (event) {
                    console.log('Player: ', player);
                    event.target.playVideo();
                };

                function onPlayerStateChange (event) {
                    if (event.data === YT.PlayerState.ENDED)
                        window.location.href = 'https://madaexplore-360.onrender.com/';
                };

                const loader = document.getElementById('loadingScreen');
                loader.style.display = 'none';
            };
        </script>
    </body>
</html>